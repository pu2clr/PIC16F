
# Controlling a DC Motor/Cooler speed with PWM

To control a motor using PWM you will need to set up a circuit with a transistor as the motor driver. 

1. **Transistor Configuration as Motor Driver**
   To control a DC motor, you can use an NPN transistor as a switch to control the motor current.

   - **NPN Transistor**: For example, a 2N2222.
   - **Motor**: A small DC motor.
   - **Recomended Flyback Diode**: For example, a 1N4001, connected in parallel with the motor to protect against voltage spikes.
   - **Base Resistor**: A resistor (for example, 1kÎ©) between the PIC's output pin and the transistor's base to limit the current.

   **Connections**:
   
   - **Collector**: Connect to the motor's negative terminal.
   - **Emitter**: Connect to ground (GND).
   - **Base**: Connect to the PIC's output pin (through the base resistor).
   - **Motor**: Connect the motor's positive terminal to the motor's power supply, and the negative terminal to the transistor's collector.
   - **Optional Flyback Diode**: Connect the anode to the transistor's collector and the cathode to the motor's power supply (positive).


## PIC16F628A example

### Schematic 

![PIC16F628A schematic](./schematic_pic16f628a_pwm.jpg)


### PIC16F628A PINOUT

![PIC16F628A PINOUT](../../images/PIC16F628A_PINOUT.png)


### PIC16F628A source code

```cpp
#include <xc.h>

#pragma config FOSC = INTOSCCLK // Internal OSC
#pragma config WDTE = OFF       // Disable Watchdog Timer
#pragma config PWRTE = OFF      // Disable Timer  Power-up
#pragma config MCLRE = ON       // 
#pragma config BOREN = ON       // 
#pragma config LVP = OFF        // 
#pragma config CPD = OFF        // 
#pragma config CP = OFF         // 

#define _XTAL_FREQ 4000000 // Internal Clock 4MHz

void main()
{
    TRISB = 0;            // Sets PORTB - output
    CCP1CON = 0b00001100; // Sets PWM
    T2CON = 0b00000111;   // Sets Timer2 prescaler of 16
    PR2 = 255;             // Sets PWM period

 
    TMR2 = 0;   // Resets Timer2 
    TMR2ON = 1; // Sets Timer2 ON 

    while (1)
    {
        // Minimum Speed
        CCPR1L = 27;
        __delay_ms(5000);
        
        // Average Speed
        CCPR1L = 33;
        __delay_ms(5000);

        // Maximum Speed
        CCPR1L = 55;
        __delay_ms(5000);
    }
}

```


## PIC16F887 example

### Circuit and Code Description for PIC16F877:

#### Circuit Description:
- **DC Motor Control**: Similar to the PIC16F628A setup, a transistor is used for motor control.  A flyback diode for protection is recomendeed but is is not used here.
- **Potentiometer for Speed Control**: The potentiometer is connected to one of the ADC-capable pins of the PIC16F877 (e.g., AN0). The other two terminals of the potentiometer are connected to VDD and GND.
- **PWM Signal Generation**: The PWM signal is generated by the PIC16F877 to control the motor speed.


### Schematic 

![PIC16F887 schematic](./schematic_pic16f887_pwm_adc.jpg)


### PIC16F628A PINOUT

![PIC16F628A PINOUT](../../images/PIC16F887_PINOUT.png)


### PIC16F628A source code

#### Code Description:
- **PWM Setup**: The CCP module is configured for PWM operation. The PWM signal's duty cycle controls the motor speed.
- **ADC Setup**: The ADC module of the PIC16F877 is configured to read the voltage at the potentiometer's wiper (connected to an ADC-capable pin).
- **Reading Potentiometer**: The ADC reads the potentiometer's position and converts it into a digital value.
- **Motor Speed Control**: Based on the ADC reading, the PWM duty cycle is adjusted, changing the motor speed.


```cpp
#include <xc.h>


// Configuration Bits
#pragma config FOSC = INTRC_NOCLKOUT  // Internal Oscillator, no clock out
#pragma config WDTE = OFF             // Watchdog Timer disabled
#pragma config PWRTE = OFF            // Power-up Timer disabled
#pragma config MCLRE = ON             // MCLR pin function is digital input
#pragma config BOREN = ON             // Brown-out Reset enabled
#pragma config LVP = OFF              // Low Voltage Programming disabled
#pragma config CPD = OFF              // Data EEPROM Memory Code Protection disabled
#pragma config CP = OFF               // Flash Program Memory Code Protection disabled

#define _XTAL_FREQ 4000000  // 4 MHz Crystal Frequency

void initPWM() {
    OSCCON = 0x60;
    TRISC = 0;                   // Set port to output   
    T2CON = 0x07;
    PR2 = 0xFF;                  // Set PWM period
    CCP1CON = 0x0C;              // Set PWM mode and duty cycle to 0
    CCPR1L = 0x00;
    T2CON = 0x04;                // Timer2 ON, Prescaler set to 1
}

void initADC() {
    ANSEL = 0x01;                // RA0/AN0 is analog input
    ADCON0 = 0x01;               // Enable ADC, channel 0
    ADCON1 = 0x80;               // Right justified, Fosc/32
}

unsigned int readADC() {
    ADCON0bits.GO = 1;           // Start conversion
    while (ADCON0bits.GO_nDONE); // Wait for conversion to finish
    return ((ADRESH << 8) + ADRESL); // Combine result into a single word
}

void main() {   
    initPWM();
    initADC();

    CCPR1L = 31;
    __delay_ms(5000);
    
    while(1) {
        unsigned int adcResult = readADC();
        CCPR1L = adcResult >> 2;  // Scale ADC result to fit PWM duty cycle register
        __delay_ms(10);           // Small delay for stability
    }
}


```